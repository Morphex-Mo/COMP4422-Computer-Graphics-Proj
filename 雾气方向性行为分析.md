# 雾气散射方向性问题分析

## 问题描述

当太阳旋转 180 度，相机也旋转 180 度后，理论上太阳相对于相机的方向保持不变，但雾气的颜色却不同。

## 原因分析

### 1. 雾气散射不仅取决于太阳相对方向

在物理真实的大气散射中，雾气的颜色取决于多个因素：

1. **太阳方向与观察方向的夹角** (`sunCosTheta = dot(viewDir, sunDirection)`)
2. **观察方向与天顶的夹角** - 用于计算光学深度
3. **观察方向与地平线的夹角** - 影响散射路径长度

即使太阳相对于相机的方向保持不变，**观察方向在世界空间中的绝对方向改变了**，这会影响：
- 光学深度的计算（依赖于观察方向与天顶的夹角）
- Rayleigh 和 Mie 散射的路径长度
- 消光效果

### 2. 光学深度的计算

在 `fog_scattering.frag.glsl` 中有三种光学深度计算：

```glsl
// 光学深度 1 - 基于观察方向与斜向量的夹角
float zenith1 = acos(clamp(dot(normalize(vec3(-1.0, 1.0, -1.0)), viewDir), 0.0, 1.0));

// 光学深度 3 - 基于观察方向与天顶的夹角
float zenith3 = acos(clamp(dot(vec3(0.0, 1.0, 0.0), viewDir), 0.0, 1.0));
```

这些计算使用的是**世界空间的固定方向向量**：
- `vec3(0.0, 1.0, 0.0)` - 天顶方向（向上）
- `vec3(-1.0, 1.0, -1.0)` - 斜向方向

当你旋转相机 180 度时，`viewDir` 从指向前方变成指向后方，它与这些固定方向的夹角完全改变了，所以光学深度不同。

### 3. 示意图

```
场景布局（俯视图）：
        
        太阳 ☀️ (0, 0.05, -1)
          ↓
    ——————————————
    |            |
    |  🎥 相机   |  ← 原始朝向：看向 +Z 方向
    |            |
    ——————————————

旋转 180 度后：

    ——————————————
    |            |
    |  相机 🎥   |  ← 新朝向：看向 -Z 方向
    |            |
    ——————————————
          ↑
    太阳 ☀️ (0, 0.05, +1)  // 也旋转了 180 度
```

虽然太阳相对于相机的方向没变（都在相机"前方"），但：
- **原始情况**：观察向量指向 +Z（较低的天顶角，接近地平线）
- **旋转后**：观察向量指向 -Z（同样低的天顶角，但方位相反）

由于光学深度 1 使用了 `vec3(-1.0, 1.0, -1.0)` 这个**非对称**的方向向量，所以两种情况的光学深度不同。

## 这是正确的物理行为吗？

**是的，这是符合物理的！** 在真实大气中：

1. **大气不是各向同性的** - 大气密度随高度变化，散射效果在不同方向上不同
2. **地平线效果** - 看向地平线时，光线穿过更厚的大气层，散射更强
3. **天顶效果** - 看向天顶时，光线穿过较薄的大气层，散射较弱

所以即使太阳相对位置相同，不同的观察方向会看到不同的雾气颜色。

## 验证方法

### 1. 检查太阳方向是否正确更新

打开控制台，按方向键调整太阳位置，应该看到：
```
[Cube Scene] Sun direction (normalized): x:0.000 y:0.050 z:-0.999
```

### 2. 检查相对角度

在 shader 中添加调试代码（临时）：

```glsl
// 在 fog_scattering.frag.glsl 的最后
vec3 debugColor = vec3(sunCosTheta * 0.5 + 0.5); // 将 -1~1 映射到 0~1
gl_FragColor = vec4(debugColor, 1.0);
return;
```

如果太阳相对角度相同，这个调试输出应该一样。

### 3. 检查光学深度

调试光学深度 3（最直观）：

```glsl
float debug = zenith3 / PI; // 0 = 天顶，0.5 = 地平线
gl_FragColor = vec4(vec3(debug), 1.0);
return;
```

旋转相机后，如果观察方向改变了，这个值应该不同。

## 如果你想要"纯相对"的雾气效果

如果你希望雾气颜色**仅取决于太阳相对于观察方向的角度**，而不考虑观察方向的绝对方向，需要修改光学深度的计算：

```glsl
// 方案1：使用统一的光学深度（基于深度值，不考虑方向）
float z_uniform = 1.0; // 或者其他固定值
float SR = kr / z_uniform;
float SM = km / z_uniform;

// 方案2：只基于太阳与观察方向的夹角
float sunZenith = acos(clamp(sunCosTheta, 0.0, 1.0));
float z = cos(sunZenith) + 0.15 * pow(93.885 - degrees(sunZenith), -1.253);
```

但这会失去物理真实性，不推荐。

## 推荐的测试方法

1. **保持相机不动，只旋转太阳** - 雾气颜色应该改变（太阳从前方移到后方）
2. **同时旋转太阳和相机 180 度** - 雾气颜色会不同（因为观察方向在世界空间中改变了）
3. **只旋转相机（太阳不动）** - 雾气颜色应该改变（观察方向改变了）

## 当前的正确行为

- ✅ 太阳在前方，看向地平线 → 强烈的 Mie 散射（金黄色）
- ✅ 太阳在后方，看向地平线 → 较弱的散射（蓝色调）
- ✅ 看向天顶，无论太阳在哪 → 主要是 Rayleigh 散射（蓝色）
- ✅ 太阳在头顶正上方 → 最少的散射

## 如何区分是 Bug 还是正确行为

在控制台输入以下测试：

```javascript
// 测试1：记录初始状态
// 太阳位置：(0, 0.05, -1)
// 相机看向：(0, 0, 0) 即中心点
// 记录雾气颜色

// 测试2：旋转太阳 180 度
// 新太阳位置：(0, 0.05, 1)
// 相机看向：仍然是 (0, 0, 0)
// 观察雾气颜色变化 → 应该有显著变化（太阳从前方到后方）

// 测试3：同时旋转相机 180 度
// 太阳位置：(0, 0.05, 1)
// 相机看向：原来的反方向
// 雾气颜色应该与测试2不同，可能部分接近测试1，但不会完全相同
```

## 结论

目前的行为**很可能是正确的物理模拟**。如果你期望的是简化的、只依赖相对角度的雾气效果，我可以修改 shader 来实现。

请告诉我：
1. 你期望的行为是什么？
2. 你是在做物理真实的渲染，还是风格化的渲染？

