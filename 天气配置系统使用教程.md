# å¤©æ°”é…ç½®ç³»ç»Ÿä½¿ç”¨æ•™ç¨‹

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

ä½ å·²ç»å®ç°äº†ä¸€å¥—å®Œæ•´çš„ Azure Sky é£æ ¼çš„å¤©æ°”é…ç½®ç³»ç»Ÿï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

### æ ¸å¿ƒç»„ä»¶

1. **AzureManager** (`src/utils/manager.ts`)
   - æ€»ç®¡ç†å™¨ï¼ŒåŒ…å« `time` å’Œ `weather` ä¸¤ä¸ªå­ç³»ç»Ÿ
   - æä¾› `buildDefaultSchema()` æ„å»ºé…ç½®ç»“æ„
   - æä¾› `buildExamplePresets()` åˆ›å»ºé¢„è®¾å¤©æ°”

2. **WeatherSystem** (`src/utils/weather-system.ts`)
   - ç®¡ç†å¤©æ°”å±æ€§ç»„ï¼ˆschemaï¼‰
   - ç®¡ç†å¤©æ°”é¢„è®¾åˆ—è¡¨
   - å¤„ç†å¤©æ°”è¿‡æ¸¡ä¸æ’å€¼

3. **WeatherPropertyGroup** & **WeatherProperty**
   - å®šä¹‰é…ç½®çš„å±‚çº§ç»“æ„
   - æ”¯æŒ Floatã€Colorã€Vector3 ç­‰ç±»å‹

4. **WeatherPreset** (`src/utils/weather-preset.ts`)
   - å­˜å‚¨å…·ä½“çš„å¤©æ°”é…ç½®æ•°æ®
   - æ”¯æŒä» schema è‡ªåŠ¨åˆ›å»º

5. **AtmosphereController** (`src/utils/atmosphere/AtmosphereController.ts`)
   - å¤©ç©ºç›’ã€é›¾æ•£å°„ã€å…‰ç…§çš„ç»Ÿä¸€æ§åˆ¶å™¨
   - å¯æŒ‚è½½ AzureManager è‡ªåŠ¨åŒæ­¥å‚æ•°

---

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ AtmosphereController + AzureManagerï¼ˆæ¨èï¼‰

è¿™æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œå·²åœ¨ `cubeScene.ts` ä¸­å®ç°ï¼š

```typescript
import { AtmosphereController } from "../utils/atmosphere/AtmosphereController";
import { AzureManager } from "../utils/manager";

// 1. åˆ›å»º AtmosphereController
const controller = new AtmosphereController({
  canvasParent: document.getElementById("app"),
  shaders: { /* ä½ çš„ shaders */ },
  options: {
    autoUpdateFromSystems: true,  // è‡ªåŠ¨ä» Azure ç³»ç»Ÿæ›´æ–°å‚æ•°
    enableDepthDebug: false,
    controls: true,
  },
});
controller.initialize();

// 2. åˆ›å»º AzureManager å¹¶æ„å»ºé…ç½®
const azureManager = new AzureManager();
azureManager.buildDefaultSchema();      // æ„å»ºé…ç½®ç»“æ„
azureManager.buildExamplePresets();    // åˆ›å»ºé¢„è®¾å¤©æ°”

// 3. æŒ‚è½½åˆ° Controller
controller.attachAzureManager(azureManager);

// 4. ä½¿ç”¨é¢„è®¾
controller.applyWeatherPreset(0);  // Clear
controller.applyWeatherPreset(1);  // Overcast
controller.applyWeatherPreset(2);  // Storm

// 5. åœ¨æ¸²æŸ“å¾ªç¯ä¸­æ›´æ–°
function loop() {
  controller.update();
  requestAnimationFrame(loop);
}
```

---

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨ä½¿ç”¨é…ç½®ç³»ç»Ÿ

å¦‚æœä½ æƒ³æ›´ç»†ç²’åº¦åœ°æ§åˆ¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `AzureManager`ï¼š

```typescript
import { AzureManager } from "../utils/manager";

// 1. åˆ›å»ºå¹¶åˆå§‹åŒ–
const azureManager = new AzureManager();
azureManager.buildDefaultSchema();
azureManager.buildExamplePresets();

// 2. åˆ‡æ¢å¤©æ°”ï¼ˆå¸¦è¿‡æ¸¡ï¼‰
const nowSec = performance.now() / 1000;
azureManager.weather.setGlobalWeatherByIndex(1, nowSec);  // åˆ‡åˆ° Overcast

// 3. åœ¨æ¯å¸§æ›´æ–°
function loop() {
  const nowSec = performance.now() / 1000;
  const deltaTimeSec = 0.016; // çº¦ 60fps
  
  // æ›´æ–°æ—¶é—´ç³»ç»Ÿ
  azureManager.time.update(deltaTimeSec);
  
  // æ›´æ–°å¤©æ°”ç³»ç»Ÿï¼ˆä¼šè‡ªåŠ¨æ’å€¼ï¼‰
  azureManager.weather.update(nowSec, deltaTimeSec);
  
  // 4. è¯»å–å½“å‰å‚æ•°
  const preset = azureManager.weather.currentWeatherPreset;
  if (preset) {
    // Scattering ç»„ (index 0)
    const scattering = preset.propertyGroupDataList[0];
    const molecularDensity = scattering.floatData[0];
    const rayleighMult = scattering.floatData[1];
    const mieMult = scattering.floatData[2];
    const rayleighColor = scattering.colorData[3];
    const mieColor = scattering.colorData[4];
    
    // Fog ç»„ (index 1)
    const fog = preset.propertyGroupDataList[1];
    const globalFogDistance = fog.floatData[0];
    const globalFogSmooth = fog.floatData[1];
    const globalFogDensity = fog.floatData[2];
    // ... å…¶ä»–é›¾æ°”å‚æ•°
    
    // Light ç»„ (index 2)
    const light = preset.propertyGroupDataList[2];
    const lightIntensity = light.floatData[0];
    const lightColor = light.colorData[1];
    
    // åº”ç”¨åˆ°ä½ çš„æè´¨/å…‰ç…§
    skyboxMaterial.uniforms.molecularDensity.value = molecularDensity;
    // ...
  }
  
  requestAnimationFrame(loop);
}
```

---

## é…ç½®ç»“æ„è¯´æ˜

### Schemaï¼ˆé…ç½®æ¨¡å¼ï¼‰

`buildDefaultSchema()` å®šä¹‰äº† 3 ä¸ªå±æ€§ç»„ï¼š

#### 1. **Scattering** ç»„ï¼ˆæ•£å°„å‚æ•°ï¼‰
- `MolecularDensity` (Float): åˆ†å­å¯†åº¦ï¼Œé»˜è®¤ 2.545
- `RayleighMultiplier` (Float): Rayleigh æ•£å°„å€æ•°ï¼Œé»˜è®¤ 1.5
- `MieMultiplier` (Float): Mie æ•£å°„å€æ•°ï¼Œé»˜è®¤ 1.0
- `RayleighColor` (Color): Rayleigh æ•£å°„é¢œè‰²
- `MieColor` (Color): Mie æ•£å°„é¢œè‰²

#### 2. **FogScattering** ç»„ï¼ˆé›¾æ°”å‚æ•°ï¼‰
- `GlobalFogDistance` (Float): å…¨å±€é›¾æ°”è·ç¦»ï¼Œé»˜è®¤ 1000
- `GlobalFogSmooth` (Float): å…¨å±€é›¾æ°”å¹³æ»‘åº¦ï¼Œé»˜è®¤ 0.25
- `GlobalFogDensity` (Float): å…¨å±€é›¾æ°”å¯†åº¦ï¼Œé»˜è®¤ 1.0
- `HeightFogDistance` (Float): é«˜åº¦é›¾æ°”è·ç¦»ï¼Œé»˜è®¤ 100
- `HeightFogSmooth` (Float): é«˜åº¦é›¾æ°”å¹³æ»‘åº¦ï¼Œé»˜è®¤ 1.0
- `HeightFogDensity` (Float): é«˜åº¦é›¾æ°”å¯†åº¦ï¼Œé»˜è®¤ 0.0
- `FogBluishDistance` (Float): é›¾æ°”è“è‰²è·ç¦»ï¼Œé»˜è®¤ 12288
- `FogBluishIntensity` (Float): é›¾æ°”è“è‰²å¼ºåº¦ï¼Œé»˜è®¤ 0.15
- `HeightFogScatterMultiplier` (Float): é«˜åº¦é›¾æ°”æ•£å°„å€æ•°ï¼Œé»˜è®¤ 0.5
- `MieDistance` (Float): Mie è·ç¦»æ§åˆ¶ï¼Œé»˜è®¤ 1.0

#### 3. **DirectionalLight** ç»„ï¼ˆå…‰ç…§å‚æ•°ï¼‰
- `LightIntensity` (Float): å…‰ç…§å¼ºåº¦ï¼Œé»˜è®¤ 0.9
- `LightColor` (Color): å…‰ç…§é¢œè‰²

### Presetsï¼ˆé¢„è®¾å¤©æ°”ï¼‰

`buildExamplePresets()` åˆ›å»ºäº† 3 ä¸ªé¢„è®¾ï¼š

1. **Clear**ï¼ˆæ™´å¤©ï¼‰
   - é›¾æ°”å°‘ã€èƒ½è§åº¦é«˜
   - æ˜äº®çš„å¤ªé˜³å…‰

2. **Overcast**ï¼ˆé˜´å¤©ï¼‰
   - ä¸­ç­‰é›¾æ°”å¯†åº¦
   - æ•£å°„å¢å¼ºã€å…‰ç…§åè“ç°

3. **Storm**ï¼ˆæš´é£é›¨ï¼‰
   - é«˜é›¾æ°”å¯†åº¦
   - å¼ºæ•£å°„ã€ä½èƒ½è§åº¦
   - æš—æ·¡å…‰ç…§

---

## åˆ›å»ºè‡ªå®šä¹‰é¢„è®¾

```typescript
import { WeatherPreset } from "./utils/weather-preset";

// 1. åŸºäº schema åˆ›å»ºé¢„è®¾
const myPreset = WeatherPreset.createFromSchema(
  azureManager.weather.weatherPropertyGroupList,
  "MyCustomWeather"
);

// 2. è®¾ç½®å‚æ•°
const scattering = myPreset.propertyGroupDataList[0];
scattering.floatData[0] = 3.0;  // MolecularDensity
scattering.floatData[1] = 2.0;  // RayleighMultiplier
scattering.floatData[2] = 1.5;  // MieMultiplier
scattering.colorData[3] = { r: 1.0, g: 0.8, b: 0.6, a: 1 };  // RayleighColor
scattering.colorData[4] = { r: 1.0, g: 0.9, b: 0.8, a: 1 };  // MieColor

const fog = myPreset.propertyGroupDataList[1];
fog.floatData[0] = 500;   // GlobalFogDistance
fog.floatData[1] = 0.3;   // GlobalFogSmooth
fog.floatData[2] = 0.8;   // GlobalFogDensity
// ... è®¾ç½®å…¶ä»–é›¾æ°”å‚æ•°

const light = myPreset.propertyGroupDataList[2];
light.floatData[0] = 0.8;  // LightIntensity
light.colorData[1] = { r: 1.0, g: 0.95, b: 0.9, a: 1 };  // LightColor

// 3. æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨
azureManager.weather.globalWeatherList.push(
  new GlobalWeatherEntry(myPreset, 5.0)  // 5ç§’è¿‡æ¸¡æ—¶é—´
);
```

---

## å‚æ•°ç´¢å¼•é€ŸæŸ¥è¡¨

ä¸ºäº†æ–¹ä¾¿è®¿é—®ï¼Œä»¥ä¸‹æ˜¯å„å‚æ•°åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼š

### Scattering ç»„ (index 0)
```typescript
const g = preset.propertyGroupDataList[0];
g.floatData[0]  // MolecularDensity
g.floatData[1]  // RayleighMultiplier
g.floatData[2]  // MieMultiplier
g.colorData[3]  // RayleighColor
g.colorData[4]  // MieColor
```

### FogScattering ç»„ (index 1)
```typescript
const g = preset.propertyGroupDataList[1];
g.floatData[0]  // GlobalFogDistance
g.floatData[1]  // GlobalFogSmooth
g.floatData[2]  // GlobalFogDensity
g.floatData[3]  // HeightFogDistance
g.floatData[4]  // HeightFogSmooth
g.floatData[5]  // HeightFogDensity
g.floatData[6]  // FogBluishDistance
g.floatData[7]  // FogBluishIntensity
g.floatData[8]  // HeightFogScatterMultiplier
g.floatData[9]  // MieDistance
```

### DirectionalLight ç»„ (index 2)
```typescript
const g = preset.propertyGroupDataList[2];
g.floatData[0]  // LightIntensity
g.colorData[1]  // LightColor
```

---

## æ—¶é—´ç³»ç»Ÿé›†æˆ

```typescript
// è®¾ç½®æ—¶é—´å¾ªç¯ï¼ˆ1 åˆ†é’Ÿä¸€ä¸ªæ˜¼å¤œï¼‰
azureManager.time.updateConfig({
  dayLength: 1.0,      // åˆ†é’Ÿ
  dawnTime: 6.0,       // é»æ˜æ—¶é—´ï¼ˆå°æ—¶ï¼‰
  duskTime: 18.0,      // é»„æ˜æ—¶é—´ï¼ˆå°æ—¶ï¼‰
});

// æ‰‹åŠ¨è®¾ç½®æ—¶é—´
azureManager.time.setTime(12.0);  // æ­£åˆ

// åœ¨å¾ªç¯ä¸­è‡ªåŠ¨æ›´æ–°æ—¶é—´
azureManager.time.update(deltaTimeSec);
```

---

## å®Œæ•´ç¤ºä¾‹

å‚è§ `src/scenes/cubeScene.ts`ï¼Œå·²ç»æ¼”ç¤ºäº†ï¼š

1. âœ… åˆ›å»º AtmosphereController
2. âœ… æŒ‚è½½ AzureManager
3. âœ… ä½¿ç”¨é¢„è®¾å¤©æ°”
4. âœ… å®šæ—¶åˆ‡æ¢å¤©æ°”ï¼ˆ2ç§’å Overcastï¼Œ10ç§’å Stormï¼‰
5. âœ… æ—¶é—´ç³»ç»Ÿè‡ªåŠ¨æ›´æ–°

---

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•çŸ¥é“å‚æ•°ç”Ÿæ•ˆäº†ï¼Ÿ
A: å¼€å¯è°ƒè¯•æ¨¡å¼ï¼š
```typescript
const controller = new AtmosphereController({
  options: { enableDepthDebug: true }
});
```

### Q: å¤©æ°”è¿‡æ¸¡ä¸å¤Ÿå¹³æ»‘ï¼Ÿ
A: è°ƒæ•´è¿‡æ¸¡æ—¶é—´ï¼š
```typescript
azureManager.weather.globalWeatherList[1].transitionTimeSec = 15.0;  // 15ç§’è¿‡æ¸¡
```

### Q: å¦‚ä½•ç¦ç”¨è‡ªåŠ¨å¤©æ°”æ›´æ–°ï¼Ÿ
A: è®¾ç½® `autoUpdateFromSystems: false`ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ `controller.overrideParameters()`

### Q: å¦‚ä½•æ·»åŠ æ›´å¤šå‚æ•°ï¼ˆå¦‚é£é€Ÿã€äº‘å±‚ï¼‰ï¼Ÿ
A: åœ¨ `buildDefaultSchema()` ä¸­æ·»åŠ æ–°çš„ WeatherPropertyï¼Œç„¶ååœ¨å„é¢„è®¾ä¸­è®¾ç½®ç›¸åº”çš„å€¼ã€‚

---

## ä¸ cubeScenebc çš„å¯¹æ¯”

| ç‰¹æ€§ | cubeScenebc (æ—§ç‰ˆ) | cubeScene (æ–°ç‰ˆ) |
|------|-------------------|------------------|
| å‚æ•°å®šä¹‰ | æ‰‹å†™ `skyParams` å¯¹è±¡ | ä½¿ç”¨ Schema + Preset ç³»ç»Ÿ |
| å‚æ•°ä¿®æ”¹ | é”®ç›˜äº‹ä»¶ç›´æ¥ä¿®æ”¹ | é€šè¿‡å¤©æ°”é¢„è®¾åˆ‡æ¢ |
| å¤©æ°”è¿‡æ¸¡ | æ—  | è‡ªåŠ¨æ’å€¼ |
| æ—¶é—´ç³»ç»Ÿ | æ—  | é›†æˆ TimeSystem |
| ä»£ç å¤ç”¨ | ä½ | é«˜ï¼ˆAtmosphereControllerï¼‰ |
| æ‰©å±•æ€§ | ä½ | é«˜ï¼ˆå¯æ·»åŠ æ–°å±æ€§ç»„ï¼‰ |

---

## ä¸‹ä¸€æ­¥

1. **æ·»åŠ  UI æ§åˆ¶å™¨**ï¼šåˆ›å»ºæ»‘å—/ä¸‹æ‹‰èœå•æ¥å®æ—¶è°ƒæ•´å‚æ•°
2. **ä¿å­˜/åŠ è½½é¢„è®¾**ï¼šæ”¯æŒ JSON å¯¼å…¥å¯¼å‡º
3. **å¤©æ°”æ—¶é—´è¡¨**ï¼šå®šä¹‰ä¸€å¤©ä¸­ä¸åŒæ—¶é—´çš„å¤©æ°”å˜åŒ–
4. **å¤©æ°”äº‹ä»¶**ï¼šç›‘å¬ `AzureEvents` å®ç°ç‰¹æ•ˆåŒæ­¥

ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸŒ¤ï¸

