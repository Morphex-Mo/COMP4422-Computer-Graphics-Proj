# åŠ¨ç”»åº“å’Œå®šæ—¶å™¨ä½¿ç”¨æ–‡æ¡£

## ğŸ“š æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åŠ¨ç”»åº“å’Œå®šæ—¶å™¨ç³»ç»Ÿï¼Œä¸“ä¸ºæ¸¸æˆå’Œå›¾å½¢åº”ç”¨è®¾è®¡ã€‚ä¸»è¦ç‰¹æ€§ï¼š

- âœ… **ä¼˜å…ˆé˜Ÿåˆ—ä¼˜åŒ–** - ä½¿ç”¨æœ€å°å †æ›¿ä»£æ’åºï¼Œæ—¶é—´å¤æ‚åº¦ O(log n)
- âœ… **å¯¹è±¡æ± ** - å‡å°‘ GC å‹åŠ›ï¼Œæé«˜æ€§èƒ½
- âœ… **æ—¶é—´å¼ºåŒæ­¥** - æ”¯æŒç²¾ç¡®çš„æ—¶é—´æ§åˆ¶
- âœ… **ä¸°å¯Œçš„ç¼“åŠ¨å‡½æ•°** - 10+ ç§å†…ç½®ç¼“åŠ¨æ•ˆæœ
- âœ… **Promise æ”¯æŒ** - ç°ä»£åŒ–çš„å¼‚æ­¥ API

---

## ğŸ¯ æ ¸å¿ƒæ¨¡å—

### 1. Timerï¼ˆå®šæ—¶å™¨ï¼‰

ç»Ÿä¸€çš„å®šæ—¶å·¥å…·ï¼Œç®¡ç†æ‰€æœ‰å»¶è¿Ÿä»»åŠ¡ã€‚

#### åŸºç¡€ä½¿ç”¨

```typescript
import { globalTimer } from './core';

// åˆå§‹åŒ–å®šæ—¶å™¨
globalTimer.init();

// æ·»åŠ å»¶è¿Ÿä»»åŠ¡ï¼ˆ1ç§’åæ‰§è¡Œï¼‰
globalTimer.addTask(1000, () => {
  console.log('1ç§’åæ‰§è¡Œ');
});

// å¸¦å‚æ•°çš„ä»»åŠ¡
globalTimer.addTask(2000, (name: string, age: number) => {
  console.log(`Hello ${name}, age: ${age}`);
}, ['Alice', 25]);
```

#### å¼‚æ­¥ Sleep

```typescript
// ä½¿ç”¨ async/await
async function demo() {
  console.log('å¼€å§‹');
  await globalTimer.sleep(1000);
  console.log('1ç§’å');
  await globalTimer.sleep(2000);
  console.log('å†ç­‰2ç§’');
}
```

#### ä»»åŠ¡ç®¡ç†

```typescript
// æ·»åŠ ä»»åŠ¡å¹¶è·å–å¼•ç”¨
const task = globalTimer.addTask(3000, () => {
  console.log('è¿™ä¸ªä»»åŠ¡ä¼šè¢«å–æ¶ˆ');
});

// å–æ¶ˆä»»åŠ¡
globalTimer.removeTask(task);

// è·å–è°ƒè¯•ä¿¡æ¯
const info = globalTimer.getDebugInfo();
console.log(info); 
// { queueSize: 5, setSize: 2, totalTasks: 10, currentTime: 1234 }
```

#### é€Ÿåº¦æ§åˆ¶

```typescript
// è®¾ç½®2å€é€Ÿ
globalTimer.setSpeed(2);

// è®¾ç½®0.5å€é€Ÿï¼ˆæ…¢åŠ¨ä½œï¼‰
globalTimer.setSpeed(0.5);
```

---

### 2. Animationï¼ˆåŠ¨ç”»ç³»ç»Ÿï¼‰

å¼ºå¤§çš„åŠ¨ç”»ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§ç¼“åŠ¨å‡½æ•°ã€‚

#### åŸºç¡€åŠ¨ç”»

```typescript
import { globalAnimationManager, Easing } from './animation';

// ç®€å•çš„æ•°å€¼åŠ¨ç”»
globalAnimationManager.animate(
  0,      // èµ·å§‹å€¼
  100,    // ç»“æŸå€¼
  1000,   // æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  (value) => {
    console.log('å½“å‰å€¼:', value);
  },
  Easing.easeInOutQuad  // ç¼“åŠ¨å‡½æ•°
).then(() => {
  console.log('åŠ¨ç”»å®Œæˆ');
});
```

#### å¯¹è±¡å±æ€§åŠ¨ç”»

```typescript
const cube = { x: 0, y: 0, rotation: 0 };

// åŠ¨ç”»å•ä¸ªå±æ€§
await globalAnimationManager.animateProperty(
  cube,
  'x',
  100,
  1000,
  Easing.easeOutBounce
);

// åŒæ—¶åŠ¨ç”»å¤šä¸ªå±æ€§
await globalAnimationManager.animateProperties(
  cube,
  { x: 100, y: 50, rotation: Math.PI },
  2000,
  Easing.easeInOutCubic
);
```

#### Three.js é›†æˆç¤ºä¾‹

```typescript
import * as THREE from 'three';

const cube = new THREE.Mesh(geometry, material);

// åŠ¨ç”»ç«‹æ–¹ä½“ä½ç½®
globalAnimationManager.animate(
  0, 5,
  2000,
  (value) => {
    cube.position.y = value;
  },
  Easing.easeOutElastic
);

// åŠ¨ç”»æ—‹è½¬
globalAnimationManager.animate(
  0, Math.PI * 2,
  3000,
  (value) => {
    cube.rotation.y = value;
  },
  Easing.linear
);
```

---

## ğŸ¨ ç¼“åŠ¨å‡½æ•°

### å¯ç”¨çš„ç¼“åŠ¨å‡½æ•°

```typescript
Easing.linear              // çº¿æ€§
Easing.easeInQuad          // äºŒæ¬¡ç¼“å…¥
Easing.easeOutQuad         // äºŒæ¬¡ç¼“å‡º
Easing.easeInOutQuad       // äºŒæ¬¡ç¼“å…¥ç¼“å‡º
Easing.easeInCubic         // ä¸‰æ¬¡ç¼“å…¥
Easing.easeOutCubic        // ä¸‰æ¬¡ç¼“å‡º
Easing.easeInOutCubic      // ä¸‰æ¬¡ç¼“å…¥ç¼“å‡º
Easing.easeOutElastic      // å¼¹æ€§ç¼“å‡º
Easing.easeOutBounce       // å›å¼¹ç¼“å‡º
```

### è‡ªå®šä¹‰ç¼“åŠ¨å‡½æ•°

```typescript
// è‡ªå®šä¹‰ç¼“åŠ¨å‡½æ•°ï¼ˆæ¥æ”¶ 0-1 çš„å€¼ï¼Œè¿”å› 0-1 çš„å€¼ï¼‰
const customEasing = (t: number): number => {
  return t * t * t; // ä¸‰æ¬¡æ–¹
};

globalAnimationManager.animate(0, 100, 1000, 
  (value) => console.log(value),
  customEasing
);
```

---

## ğŸ”§ é«˜çº§ç‰¹æ€§

### 1. ä¼˜å…ˆé˜Ÿåˆ—å®ç°

å†…éƒ¨ä½¿ç”¨æœ€å°å †å®ç°ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯”ä¼ ç»Ÿæ’åºæ–¹æ³•æ›´é«˜æ•ˆï¼š

```typescript
// æ·»åŠ 10000ä¸ªä»»åŠ¡åªéœ€è¦å‡ æ¯«ç§’
for (let i = 0; i < 10000; i++) {
  globalTimer.addTask(Math.random() * 10000, () => {
    // ä»»åŠ¡å†…å®¹
  });
}
```

### 2. å¯¹è±¡æ± 

å‡å°‘ GC å‹åŠ›ï¼Œè‡ªåŠ¨å¤ç”¨ä»»åŠ¡å¯¹è±¡ï¼š

```typescript
// å†…éƒ¨è‡ªåŠ¨ä½¿ç”¨å¯¹è±¡æ± ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†
globalTimer.addTask(1000, () => {});
// ä»»åŠ¡æ‰§è¡Œåï¼Œå¯¹è±¡ä¼šè¢«å›æ”¶åˆ°å¯¹è±¡æ± 
```

### 3. æ—¶é—´å¼ºåŒæ­¥

å¯ç”¨æ—¶é—´å¼ºåŒæ­¥æ¨¡å¼ï¼š

```typescript
import { Timer } from './core';

// åˆ›å»ºå¯ç”¨æ—¶é—´å¼ºåŒæ­¥çš„å®šæ—¶å™¨
const timer = new Timer({ 
  forceTimeSync: true,
  speed: 1 
});

timer.init();
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

```typescript
import { runPerformanceTest } from './demo';

// è¿è¡Œæ€§èƒ½æµ‹è¯•
runPerformanceTest();

// è¾“å‡ºç¤ºä¾‹ï¼š
// æ·»åŠ  10000 ä¸ªä»»åŠ¡...
// âœ“ æ·»åŠ å®Œæˆï¼Œè€—æ—¶: 12.34ms
// ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€: { queueSize: 9998, setSize: 2, ... }
```

---

## ğŸ® å®Œæ•´ç¤ºä¾‹

```typescript
import * as THREE from 'three';
import { globalTimer } from './core';
import { globalAnimationManager, Easing } from './animation';

// åˆå§‹åŒ–å®šæ—¶å™¨
globalTimer.init();

// åˆ›å»º Three.js åœºæ™¯
const scene = new THREE.Scene();
const cube = new THREE.Mesh(
  new THREE.BoxGeometry(1, 1, 1),
  new THREE.MeshPhongMaterial({ color: 0x00ff00 })
);
scene.add(cube);

// å»¶è¿Ÿ1ç§’åå¼€å§‹åŠ¨ç”»
globalTimer.addTask(1000, async () => {
  console.log('å¼€å§‹åŠ¨ç”»åºåˆ—');
  
  // ä¸Šå‡
  await globalAnimationManager.animateProperty(
    cube.position, 'y', 5, 2000, Easing.easeOutCubic
  );
  
  console.log('ä¸Šå‡å®Œæˆ');
  
  // ç­‰å¾…1ç§’
  await globalTimer.sleep(1000);
  
  // ä¸‹é™ï¼ˆå¸¦å›å¼¹æ•ˆæœï¼‰
  await globalAnimationManager.animateProperty(
    cube.position, 'y', 0, 2000, Easing.easeOutBounce
  );
  
  console.log('åŠ¨ç”»åºåˆ—å®Œæˆ');
});

// åŒæ—¶æ—‹è½¬ç«‹æ–¹ä½“
globalAnimationManager.animate(
  0, Math.PI * 2,
  5000,
  (value) => {
    cube.rotation.y = value;
  },
  Easing.linear
);
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è°ƒè¯•æ¨¡å¼

```typescript
const timer = new Timer({ debug: true });
```

### 2. æŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€

```typescript
const info = globalTimer.getDebugInfo();
console.log('ä»»åŠ¡é˜Ÿåˆ—å¤§å°:', info.queueSize);
console.log('çŸ­ä»»åŠ¡é›†åˆå¤§å°:', info.setSize);
console.log('å½“å‰æ—¶é—´:', info.currentTime);
```

### 3. ç›‘æ§åŠ¨ç”»

```typescript
const manager = globalAnimationManager;
console.log('å½“å‰åŠ¨ç”»æ•°é‡:', manager.size);
```

---

## ğŸ“ API å‚è€ƒ

### Timer API

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `init()` | `callback?, args?` | `void` | åˆå§‹åŒ–å®šæ—¶å™¨ |
| `addTask()` | `delayTime, callback, args?, useSet?` | `TaskObject` | æ·»åŠ ä»»åŠ¡ |
| `removeTask()` | `task` | `void` | ç§»é™¤ä»»åŠ¡ |
| `sleep()` | `delayTime` | `Promise<void>` | å¼‚æ­¥å»¶è¿Ÿ |
| `setSpeed()` | `speed` | `void` | è®¾ç½®é€Ÿåº¦ |
| `getTime()` | - | `number` | è·å–å½“å‰æ—¶é—´ |
| `start()` | - | `void` | å¯åŠ¨å®šæ—¶å™¨ |
| `stop()` | - | `void` | åœæ­¢å®šæ—¶å™¨ |
| `clear()` | - | `void` | æ¸…ç©ºä»»åŠ¡ |
| `getDebugInfo()` | - | `object` | è·å–è°ƒè¯•ä¿¡æ¯ |

### AnimationManager API

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `animate()` | `from, to, duration, onUpdate, easing?` | `Promise<void>` | åˆ›å»ºæ•°å€¼åŠ¨ç”» |
| `animateProperty()` | `target, property, to, duration, easing?` | `Promise<void>` | åŠ¨ç”»å¯¹è±¡å±æ€§ |
| `animateProperties()` | `target, properties, duration, easing?` | `Promise<void[]>` | åŠ¨ç”»å¤šä¸ªå±æ€§ |
| `add()` | `id, from, to, options` | `Animation` | æ·»åŠ åŠ¨ç”» |
| `get()` | `id` | `Animation \| undefined` | è·å–åŠ¨ç”» |
| `remove()` | `id` | `void` | ç§»é™¤åŠ¨ç”» |
| `clear()` | - | `void` | æ¸…ç©ºæ‰€æœ‰åŠ¨ç”» |

---

## ğŸš€ æœ€ä½³å®è·µ

1. **ä½¿ç”¨å¯¹è±¡æ± ** - ç³»ç»Ÿå·²è‡ªåŠ¨ä¼˜åŒ–ï¼Œé¢‘ç¹åˆ›å»ºä»»åŠ¡ä¸ä¼šé€ æˆæ€§èƒ½é—®é¢˜
2. **çŸ­ä»»åŠ¡ç”¨ Set** - 15ms ä»¥ä¸‹çš„ä»»åŠ¡ä¼šè‡ªåŠ¨ä½¿ç”¨ Set å­˜å‚¨ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®š
3. **é•¿ä»»åŠ¡ç”¨ä¼˜å…ˆé˜Ÿåˆ—** - 15ms ä»¥ä¸Šçš„ä»»åŠ¡ä¼šè‡ªåŠ¨ä½¿ç”¨æœ€å°å †ï¼Œæ€§èƒ½æœ€ä¼˜
4. **åˆç†ä½¿ç”¨ async/await** - ä½¿ä»£ç æ›´æ¸…æ™°æ˜“è¯»
5. **åŠæ—¶æ¸…ç†** - ä¸éœ€è¦çš„ä»»åŠ¡åŠæ—¶ç§»é™¤

---

## ğŸ’¡ æç¤º

- æŸ¥çœ‹ `src/demo.ts` è·å–æ›´å¤šç¤ºä¾‹
- æ‰€æœ‰æ—¶é—´å•ä½éƒ½æ˜¯æ¯«ç§’
- æ”¯æŒ TypeScript ç±»å‹æç¤º
- å…¼å®¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨

