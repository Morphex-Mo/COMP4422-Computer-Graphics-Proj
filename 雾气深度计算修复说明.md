# 雾气着色器深度计算修复

## 问题诊断

你提到"雾气计算的光照反过来了"，这是因为深度归一化的方向错误。

### 原始错误

```glsl
// 错误：这会让近处的物体 depth = 1，远处的物体 depth = 0
float depth = (cameraFar - dist) / (cameraFar - cameraNear);
```

### 修复后

```glsl
// 正确：近处的物体 depth = 0，远处的物体 depth = 1（符合 Unity 的 Linear01Depth）
float depth = (dist - cameraNear) / (cameraFar - cameraNear);
depth = clamp(depth, 0.0, 1.0);
```

## Unity Linear01Depth 说明

在 Unity 中，`Linear01Depth(depthBuffer)` 返回：
- **0.0** - 近裁剪平面（cameraNear）
- **1.0** - 远裁剪平面（cameraFar）
- 中间值 - 线性插值

公式：
```
Linear01Depth = (linearDepth - near) / (far - near)
```

而不是：
```
Linear01Depth = (far - linearDepth) / (far - near)  // 这是错的！
```

## 光学深度 1 的修复

### 原始代码（有误）

```glsl
// 错误：vec3(depth) 会把标量 depth 扩展为 vec3(depth, depth, depth)
float zenith1 = acos(clamp(dot(normalize(vec3(-1.0, 1.0, -1.0)), vec3(depth)), 0.0, 1.0));
```

### 修复后

```glsl
// 正确：使用 viewDir（世界空间方向向量）
float zenith1 = acos(clamp(dot(normalize(vec3(-1.0, 1.0, -1.0)), viewDir), 0.0, 1.0));
```

## Azure Sky 雾气着色器对照表

| Azure Sky (HLSL) | 我们的实现 (GLSL) | 说明 |
|------------------|-------------------|------|
| `Linear01Depth(UNITY_SAMPLE_DEPTH(tex2D(_CameraDepthTexture, Input.DepthUV)))` | `(dist - cameraNear) / (cameraFar - cameraNear)` | 深度归一化 0-1 |
| `depth * (_ProjectionParams.z / 10000.0f)` | `depth * (cameraFar / 10000.0)` | Mie 深度缩放（小尺度） |
| `depth * (_ProjectionParams.z / 1000.0f)` | `depth * (cameraFar / 1000.0)` | Mie 深度缩放（大尺度） |
| `length(depth * Input.InterpolatedRay.xyz)` | `dist` | 片段到相机的距离 |
| `worldSpaceDirection.y` | `worldPos.y` | 世界空间高度 |

## 关键变量说明

```glsl
// 深度和距离变量
float fragCoordZ;    // NDC 深度 [0, 1]，从深度缓冲读取
float viewZ;         // 视图空间 Z（负值，因为相机看向 -Z）
float dist;          // 片段到相机的实际距离（正值）
float depth;         // 归一化深度 [0, 1]，0=near, 1=far

// 位置和方向变量
vec3 worldPos;       // 片段的世界空间位置
vec3 cameraPos;      // 相机的世界空间位置
vec3 viewDir;        // 从相机指向片段的归一化方向

// 雾气密度变量
float globalFog;     // 全局雾气密度 [0, 1]
float heightFog;     // 高度雾气密度 [0, 1]
float totalFog;      // 总雾气密度 [0, 1]
```

## 深度计算流程图

```
深度缓冲 (fragCoordZ) 
    ↓ perspectiveDepthToViewZ()
视图空间 Z (viewZ, 负值)
    ↓ 取负号
片段距离 (dist, 正值)
    ↓ 归一化 (dist - near) / (far - near)
归一化深度 (depth, 0-1)
    ↓ 用于雾气计算
雾气密度 (totalFog, 0-1)
```

## 测试方法

运行项目后，你应该看到：

1. **近处物体** - 几乎没有雾气（depth ≈ 0）
2. **远处物体** - 雾气浓厚（depth ≈ 1）
3. **地平线** - 雾气最浓
4. **天顶** - 雾气较少

使用键盘调整：
- `1/2` - 调整全局雾气距离（100-5000）
- `3/4` - 调整全局雾气密度（0-2.0）
- `5/6` - 调整高度雾气密度（0-2.0）

如果雾气效果仍然"反过来"（近处浓，远处淡），说明深度归一化还有问题。

