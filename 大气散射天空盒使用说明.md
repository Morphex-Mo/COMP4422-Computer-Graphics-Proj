# 大气散射天空盒使用说明

## 概述

Cube Scene 现在使用基于物理的大气散射天空盒，模拟真实的 **Rayleigh 散射**和 **Mie 散射**效果。

## 物理原理

### Rayleigh 散射（瑞利散射）
- **原理**：光被小于波长的粒子（如空气分子）散射
- **特点**：短波长（蓝光）比长波长（红光）散射更强烈
- **效果**：产生蓝天效果，日出日落时的红色天空

### Mie 散射（米氏散射）
- **原理**：光被接近波长大小的粒子（如水滴、尘埃）散射
- **特点**：对所有波长散射程度相似，有强烈的前向散射
- **效果**：产生太阳周围的光晕，白天的朦胧感

## 参数说明

### 可调节参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `rayleigh` | 2.0 | Rayleigh 散射系数，控制天空蓝色的强度 |
| `turbidity` | 10.0 | 浑浊度，影响 Mie 散射强度和天空的朦胧程度 |
| `mieCoefficient` | 0.005 | Mie 散射系数，控制大气中颗粒的散射 |
| `mieDirectionalG` | 0.8 | Mie 散射方向性，控制太阳光晕的大小 |
| `luminance` | 1.0 | 整体亮度 |
| `sunPosition` | (0, 0.05, -1) | 太阳位置（影响天空颜色变化）|

## 交互控制

### 键盘控制

- **D 键**：切换深度图显示
- **↑ 键**：提高太阳高度（模拟正午）
- **↓ 键**：降低太阳高度（模拟日出/日落）
- **← 键**：向左旋转太阳方位
- **→ 键**：向右旋转太阳方位
- **T 键**：增加浑浊度（天空更朦胧）
- **G 键**：减少浑浊度（天空更清澈）
- **R 键**：增加 Rayleigh 散射（天空更蓝）
- **F 键**：减少 Rayleigh 散射（天空偏白）

## 视觉效果

### 不同太阳高度的效果

1. **太阳高空（y > 0.2）**
   - 天空呈现明亮的蓝色
   - Rayleigh 散射主导
   - 清晰的天空

2. **太阳地平线（y ≈ 0）**
   - 地平线附近呈现橙红色
   - 光线穿过更厚的大气层
   - Rayleigh 散射产生日落色彩

3. **太阳低于地平线（y < 0）**
   - 夜空效果
   - 太阳光逐渐消失
   - 暗蓝色天空

### 浑浊度效果

- **低浑浊度（< 5）**：清澈的天空，强烈的蓝色
- **中浑浊度（5-15）**：正常天气，柔和的散射
- **高浑浊度（> 15）**：雾霾天气，白色朦胧的天空

## 技术实现

### 着色器文件

- **顶点着色器**：`atmospheric_scattering.vert.glsl`
  - 计算散射系数
  - 太阳强度计算
  - 传递必要的 varying 变量

- **片段着色器**：`atmospheric_scattering.frag.glsl`
  - Rayleigh 相位函数
  - Mie 相位函数（Henyey-Greenstein）
  - Uncharted 2 色调映射
  - 太阳圆盘渲染

### 核心公式

1. **Rayleigh 相位函数**：
   ```glsl
   float rayleighPhase(float cosTheta) {
       return (3.0 / (16.0 * pi)) * (1.0 + pow(cosTheta, 2.0));
   }
   ```

2. **Mie 相位函数（HG）**：
   ```glsl
   float hgPhase(float cosTheta, float g) {
       float g2 = pow(g, 2.0);
       float inverse = 1.0 / pow(1.0 - 2.0 * g * cosTheta + g2, 1.5);
       return (1.0 / (4.0 * pi)) * ((1.0 - g2) * inverse);
   }
   ```

## 性能优化

- 天空盒使用低多边形球体（32x32）
- 深度写入关闭（`depthWrite: false`）
- 在顶点着色器中预计算散射系数
- 使用 `gl_Position.z = gl_Position.w` 确保天空盒总在最远处

## 未来改进

可能的扩展方向：

1. **动态时间系统**：自动更新太阳位置模拟一天的时间变化
2. **星空**：在夜间添加星星效果
3. **云层**：添加程序化生成的云
4. **月亮**：添加月亮和月光效果
5. **实时天气**：根据天气数据调整参数

## 参考资料

- [GPU Gems 2 - Accurate Atmospheric Scattering](https://developer.nvidia.com/gpugems/gpugems2/part-ii-shading-lighting-and-shadows/chapter-16-accurate-atmospheric-scattering)
- [Precomputed Atmospheric Scattering](https://ebruneton.github.io/precomputed_atmospheric_scattering/)
- [Three.js Sky Shader](https://github.com/mrdoob/three.js/blob/master/examples/jsm/objects/Sky.js)

